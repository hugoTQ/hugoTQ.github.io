关于批处理任务：

- 考虑并发性能最大化，每个分段并发上传，例如5个文件，每个文件若分为10段，则50个段并发上传。

- 批处理上传任务结果的3中情况

  1. 所有文件（其中的所有分段）上传完成。
  2. 若其中一个分段上传失败（已重试5次），则整个批处理视为失败
  3. cte需要stop上传任务

  其中情况2和3需要做：

  1. 清理正在上传的文件

   	2. 未上传的文件不再上传
   	3. 已上传完成的文件不作处理（在删除任务流程中清理）

- 考虑并发性能最大化，分段上传做并发，则每个分段都需要一个文件描述符，受操作系统打开文件数限制（cte一般设置为1000000），一个批处理任务中 分段数x文件数< 1w，超出这个限制则分为多个批处理上传任务

- 多个批处理上传任务串行处理

- 批处理任务需要有超时控制，利用已上传分段数做超时判断

- 多线程都有可能改变批处理任务状态，存在竟态，考虑减少使用锁和对象释放造成空指针等问题，还是分为数据通道和，消息通道。数据通道为批处理信息，copy对象，线程各自管理对象生命周期；任务状态由消息通道交互。

- 考虑线程数较多，减少线程创建销毁开销，以及方便控制最大线程数，使用线程池。

- 注意异常处理，清除上传任务，否则造成obs碎片累积，会收费

- 第一次申请套多uploadid OBS服务器会没有响应（100个以上？）

  
  
  

关于异常处理：

1. applyid失败
   1. 该file置为failed，不需要？
   2. 其他file调用abort接口，与uploadpart存在并发问题。。。。。
   3. bat返回失败
2. 段上传失败
3. list、complete失败
4. io下发abort



测试：

1. 大量大文件
2. 大量小文件
3. 保证上传完成文件的acl，权限没问题

异常：

1. obs参数错误
2. 申请id异常
3. 上传某段异常
4. listpart异常
5. complete异常

遗留问题：

3. abort
6. 队列长度
7. 线程池长度
4. 插入多个到队列
5. 去掉assert



并发限制：

1. 线程数，操作系统
2. 打开文件局句柄数
3. 链接数，实测会造成apollo动态配置curl coredump



### 测试1：文件1GB x 10：

- 并发数：20

- 段大小：1G

```SHELL
682:192.168.22.127|mts|product|2019-06-17T17:00:43.240+08:00|INFO|17043|2|main.c|main|1023|speed:.445951 sizeSum:-616309662, times:1 cost:211.000000 errcode:0 errinfo:
1291:192.168.22.127|mts|product|2019-06-17T17:04:13.535+08:00|INFO|17043|2|main.c|main|1023|speed:.520645 sizeSum:-616309662, times:2 cost:421.000000 errcode:0 errinfo:
1900:192.168.22.127|mts|product|2019-06-17T17:07:43.610+08:00|INFO|17043|2|main.c|main|1023|speed:.551961 sizeSum:-616309662, times:3 cost:631.000000 errcode:0 errinfo:
```

- 并发数：20
- 不分段





old：

```SHELL
417:192.168.22.127|mts|product|2019-06-17T17:57:27.257+08:00|INFO|4836|115|main.c|main|1021|speed:331294.937743 sizeSum:115343360000 cost:340.000000
```



### 测试2：文件50MB x 2048：

- 并发数：20

- 段大小：1G

```shell
30783:192.168.22.127|mts|product|2019-06-18T11:46:00.490+08:00|INFO|18420|115|main.c|main|1033|111 speed:535248.979592kb/s sizeSum:107426611200, times:1 cost:196.000000 errcode:0 errinfo
```

- 并发数：20
- 不分段直接上传

```SHELL
	
```



old：

```SHELL
24631:192.168.22.127|mts|product|2019-06-18T11:42:44.763+08:00|INFO|18420|115|main.c|main|1021|speed:211509.677419 sizeSum:107426611200 cost:496.00000
```

// 上报结构体：srcpath，despath，filesize，doneSize，avaragespeed，peekspeek









1.介绍功能点

  - 小于1GB的文件直接上传，大于1GB的文件按每段1GB分段上传
  - 文件之间并发上传，段之间并发上传
  - 某个文件/段上传异常后，要停止该次批量上传，清理已上传碎片
  - 外部可以通知停止批量上传
  - 分段阈值可配，段大小可配
  - 每段需要打开文件句柄，受操作系统限制，总分段数需要限制
  - 利用线程池减少创建销毁线程开销















