

[TOC]

#   C语言重构

## 基础原则

### 删除废弃代码

1. 删掉注释代码

   开发阶段注释代码方便重构，上库检视注释代码是否有必要保留，CTE有几千行注释的以后也不可能用的代码，假如后面可能还有用的注释块代，请写下保留理由，理论上大部分注释代码都没必要保留，查看历史版本即可

2. 删除无用变量

   例如下面这个valid变量，注释已写明该变量已弃用

![1548991664992](C:\Users\h00379181\AppData\Roaming\Typora\typora-user-images\1548991664992.png)

引用valid的地方都是if判断和赋1，删掉不会影响功能，立马简化很多逻辑，写下这个注释的人怎么想的。。。。

![1548991804318](C:\Users\h00379181\AppData\Roaming\Typora\typora-user-images\1548991804318.png)

3. 删掉无用参数

![1548993460261](C:\Users\h00379181\AppData\Roaming\Typora\typora-user-images\1548993460261.png)

![1548993506063](C:\Users\h00379181\AppData\Roaming\Typora\typora-user-images\1548993506063.png)

可以看到up_mail_index 在函数内没有到，随着代码改动，无用的参数都删了吧。。

我认为上面是最基本的编码习惯了，按理不需要提出来

### 错误单词

spilte -> spilt

templet->template

### 命名

函数，结构体类型，枚举类型，联合体类型大驼峰
全局变量，局部变量，局部常量，函数参数，宏参数，结构体中字段，联合体中成员小驼峰
宏，全局常量(const)，枚举值，goto 标签全大写，下划线分割

### 结构体

- typedef 使用匿名结构体，指针自嵌套，加上tag前缀
- 

c文件应该放结构体吗？

结构体上下两个命名？大小写等规范

### 函数

入参

static的好处

###　常量

放头c文件还是头文件？

注释怎么写？

### 错误返回

错误码太细会导致代码不好写？底层设置

### 异常处理

### 宏定义

### 注释

###　排版

### 可读性

## 重构有基本原则

- 小步重构，用例保障。

# CTE 重构

原则：

- 可读性
- 扩展性
- 开发效率
- 质量保障

方法：

- 模块划分
- 命名
- 函数行数
- 结构体定义
- 降低耦合



**搜下TODO**

## 不用extern

## 宏重复

1. 基础类型

u32 INT32

NULL NULL_PTR

基本类型为什么定义宏？typedef SIZE_T size_t

io不涉及业务，只用valid判断，输入文件，输出文件封装一个结构体。具体valid和文件名独立业务层做

2. 相关代码

cte_typedef.h

pub.h

## master->io->imedia 统一结构体

- 干掉start_***_req里可以在task_ccb获取的信息
- 整理task_ccb，抽出结构体
  - 邮箱
  - path
  - 
- 邮箱
- 各种输入输出路径
- 各种标志位
- 各种枚举类型

## 命名

- 规范
- 统一命名
  - cutpic。。screenshot。。thumnail。。JPEG。。。
  - 参考公司最新规范
- 命名不好

## 重复代码

- 模块/函数
- 结构

## 无效代码

- 头文件
- 打印
- tagMC_DP_MSG_TYPE_EN
- 

## 类型转换

## ctm->cte->imeda 

- 建议cte尽量用imedia枚举，ctm不能统一则在cte做转换
- ctm下发模板参数已做保证的逻辑，cte不做复杂的校验，用例保障
- 相关代码
  - xcode_common.h  
  - conver_struct.c  
  - tc_enum.h

## 抽出业务无关的公共代码->utils

- 字符串操作

## 邮箱

- index

## 任务ID（问题定位）

1. 能表示分片转码合并
2. 易搜索不要中括号，例如ID=11111
3. 保证每条日志都带uniqueid，能提供统一接口方便编码
4. 能否实现withfield，带上基本的信息，也不用每个函数传taskccb

## 其他待优化

- obs并行上传
- task remove 关掉后，tmp_media 会有重复，obs会上传老文件
- 没有删除字幕与水印的临时文件

## 错误处理

- 考虑使用goto简化代码
- 规划化设置错误码

## 统一代码规范（参考公司最新规范）

- 头文件包含
  - 在头文件里包含，不要在c文件里依赖顺序
- if else

# C语言代码规范

建议5.5